package au.com.thoughtpatterns.djs.examples

import au.com.thoughtpatterns.djs.lib.Library
import au.com.thoughtpatterns.dj.disco.tangoinfo.TangoInfo
import au.com.thoughtpatterns.djs.disco.Disco
import au.com.thoughtpatterns.djs.disco.Disco.TangoInfo.TiTrack
import au.com.thoughtpatterns.djs.lib.MusicFile
import java.io.File

object CD {

  def main(args: Array[String]) = {

    println("Start analysis")
    
    val lib = Library.load(new java.io.File("jamie.djs"))

    val disco = lib.ourDisco

    var tracks = Disco.TangoInfo.tiTracks

    def toAlbum(t: TiTrack) = t.tint.tin

    val albums = tracks groupBy toAlbum

    val batc = List(
      "02480002152842",
      "02480002153122",
      "02480002152194",
      "02480002152477",
      "02480002153276",
      "02480002152125",
      "02480002152538",
      "02480002152545",
      "02480002152934",
      "02480002152101",
      "02480002152170",
      "02480002152187",
      "02480002152255",
      "02480002153115",
      "02480002153191",
      "02480002153375",
      "02480002153429",
      "02480002153337",
      "02480002152460",
      "02480002153351",
      "02480002152392",
      "02480002153214",
      "02480002153344",
      "02480002153108",
      "02480002153368",
      "02480002152217",
      "02480002153177",
      "02480002153139",
      "02480002153399",
      "02480002153405",
      "02480002152286",
      "02480002152293",
      "02480002152088",
      "02480002152750",
      "02480002152132",
      "02480002153436",
      "02480002152071",
      "02480002152347",
      "02480002152354",
      "02480002152163",
      "02480002153085",
      "02480002152262",
      "02480002152514",
      "02480002152521",
      "02480002152279",
      "02480002152033",
      "02480002152378",
      "02480002152590",
      "02480002152507",
      "02480002152408",
      "02480002152040",
      "02480002152774",
      "02480002152620",
      "02480002152705",
      "02480002152736",
      "02480002152712",
      "02480002152231",
      "02480002152583",
      "02480002152576",
      "02480002152637",
      "02480002152118",
      "02480002152699",
      "02480002152644",
      "02480002152651",
      "02480002152767",
      "02480002152385",
      "02480002152613",
      "02480002152439",
      "02480002152729",
      "02480002152019",
      "02480002152668",
      "02480002152675",
      "02480002152224",
      "02480002152811",
      "02480002153283",
      "02480002153153",
      "02480002152569",
      "02480002152200",
      "02480002152835",
      "02480002152095",
      "02480002153306",
      "02480002152941",
      "02480002152989",
      "02480002153054",
      "02480002153382",
      "02480002152958",
      "02480002153238",
      "02480002152149",
      "02480002152156",
      "02480002152316",
      "02480002152446",
      "02480002152453",
      "02480002152309",
      "02480002152064",
      "02480002152606",
      "02480002152057",
      "02480002152484",
      "02480002152743",
      "02480002152682",
      "02480002152828",
      "02480002152798",
      "02480002153207",
      "02480002153313",
      "02480002152552",
      "02480002152996",
      "02480002152330",
      "02480002152323",
      "02480002153245",
      "02480002152248",
      "02480002152491",
      "02480002152026",
      "02480002152422",
      "02480002152781",
      "02480002152415",
      "02480002152859",
      "02480002152972",
      "02480002153146",
      "02480002153009",
      "02480002153092",
      "02480002153061",
      "02480002153221",
      "02480002153412",
      "02480002153290",
      "02480002153252",
      "02480002153078",
      "02480002152804",
      "02480002153269",
      "02480002152361",
      "02480002153160",
      "02480002153184",
      "02480002153320",
      "02480002152965",
      "02480002152873",
      "02480002152880",
      "02480002152897",
      "02480002152903",
      "02480002152910",
      "02480002152866",
      "02480002152927",
      "02480002153016",
      "02480002153023",
      "02480002153030",
      "02480002153047",
      "02480002159186",
      "02480002159162",
      "02480002159155",
      "02480002159148",
      "02480002159179",
      "02480002159025",
      "02480002159063",
      "02480002159070",
      "02480002159094",
      "02480002159124",
      "02480002159131",
      "02480002159018",
      "02480002159032",
      "02480002159087",
      "02480002159117",
      "02480002159049",
      "02480002159100",
      "02480002159056",
      "00724385512520",
      "00743218369926",
      "00743218625121",
      "00743218804229",
      "00828765329620",
      "00828766456226",
      "00724385642128",
      "00724385998324",
      "00743215338321",
      "00743215774228",
      "00743216531622",
      "00724349914025",
      "00743217346324",
      "00743217777029")

    def grouper(m: MusicFile) = m.toApproxPerformance

    val perfs = lib.m.groupBy(grouper)

    def toCoset(t: TiTrack) = disco.equiv.coset(t.toPerformance.perf)

    def toFile(c: Disco.Equivalence#Coset): Option[File] = {
      for (m <- c.members) {
        val lp = m.toLibPerformance
        val ps = perfs.getOrElse(lp, Nil)
        if (ps.size > 0) {
          return Some(ps.iterator.next.file)
        }
      }
      return None
    }

    for (tin <- batc) {

      println(tin + "=====================")

      val x = albums.getOrElse(tin, Nil)
      for (y <- x) {
        val file = toFile(toCoset(y))
        if (file.isEmpty) {
          println(tin + ": " + y)
        }
      }
    }

  }

}